<!doctype html>
<html lang=ru>
<head>
    <meta charset=utf-8>
    <meta content="width=device-width,initial-scale=1" name=viewport>
    <meta content="Введение, простой echo-бот" name=description>
    <meta content="#FFFFFF" name=theme-color>
    <meta content="Пишем ботов для Telegram на языке Python" property="og:title">
    <meta content="article" property="og:type">
    <meta content="Урок 1: Введение, простой echo-бот" property="og:description">
    <meta content="https://mastergroosha.github.io/telegram-tutorial/docs/lesson_01/" property="og:url">
    <meta content="Пишем ботов для Telegram на языке Python" property="og:site_name">
    <meta content="https://mastergroosha.github.io/telegram-tutorial/bot_logo.png" property="og:image">
    <title>Урок 1: Введение, простой echo-бот | Пишем ботов для Telegram на языке Python</title>
    <link href=/telegram-tutorial/manifest.json rel=manifest>
    <link href=/telegram-tutorial/favicon.png rel=icon type=image/x-icon>
    <link href=/telegram-tutorial/book.min.6df681b0bb21155cba49f6078e3559216772d8e03e780d240c73ea21817ed5e5.css
          integrity="sha256-bfaBsLshFVy6SfYHjjVZIWdy2OA+eA0kDHPqIYF+1eU="
          rel=stylesheet>
</head>
<body><input class=hidden id=menu-control type=checkbox>
<main class="container flex">
    <aside class=book-menu>
        <nav><h2 class=book-brand><a href=/telegram-tutorial><span>Пишем ботов для Telegram на языке Python</span></a>
        </h2>
            <ul>
                <li class=book-section-flat><span>pyTelegramBotAPI</span>
                    <ul>
                        <li><a href=/telegram-tutorial/docs/pyTelegramBotAPI/lesson_00/>Урок 0. Подготовка рабочего
                            места в Windows и Linux. Virtual Environment (venv). Ответы на вопросы</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_01/ class=active>Урок 1. Введение, простой
                            echo-бот</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_02/>Урок 2. «Угадай мелодию». Подготовка</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_03/>Урок 3. «Угадай мелодию». Завершаем бота</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_04/>Урок 4. Вебхуки</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_05/>Урок 5. Автопостинг в каналы</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_06/>Урок 6. Собираем аналитику при помощи Botan
                            (неактуально)</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_07/>Урок 7. Встраиваемые боты (Inline)</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_08/>Урок 8. Bot API v2: Кнопки и редактирование
                            сообщений</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_09/>Урок 9. Bot API v2: Специальные кнопки, опять
                            редактирование сообщений, кэшированный инлайн</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_10/>Урок 10. Bot API v3. Автоматизируем работу в
                            группах</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_11/>Урок 11. Ведём (более-менее) осмысленные диалоги.
                            Конечные автоматы</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_12/>Урок 12. Запускаем несколько ботов на одном
                            сервере</a></li>
                    </ul>
                </li>
                <li class=book-section-flat><span>aiogram</span>
                    <ul>
                        <li><a href=/telegram-tutorial/docs/lesson_13/>Урок 13. Опросы v2.0</a></li>
                        <li><a href=/telegram-tutorial/docs/lesson_14/>Урок 14. Конечные автоматы в aiogram, разбиваем
                            логику по файлам</a></li>
                    </ul>
                </li>
            </ul>
            <ul>
                <li><a href=/telegram-tutorial/posts/></a></li>
            </ul>
        </nav>
        <script>(function () {
            var menu = document.querySelector("aside.book-menu nav");
            addEventListener("beforeunload", function (event) {
                localStorage.setItem("menu.scrollTop", menu.scrollTop);
            });
            menu.scrollTop = localStorage.getItem("menu.scrollTop");
        })();</script>
    </aside>
    <div class=book-page>
        <header class=book-header>
            <div class="flex align-center justify-between"><label for=menu-control><img
                    alt=Menu class=book-icon src=/telegram-tutorial/svg/menu.svg></label>
                <strong>Урок 1</strong>
                <label for=toc-control><img alt="Table of Contents" class=book-icon src=/telegram-tutorial/svg/toc.svg></label>
            </div>
            <input class=hidden id=toc-control type=checkbox>
            <aside class="hidden clearfix">
                <nav id=TableOfContents>
                    <ul>
                        <li>
                            <ul>
                                <li><a href=#подготовка-к-запуску>Подготовка к запуску</a></li>
                                <li><a href=#пишем-простого-echo-бота>Пишем простого echo-бота</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </aside>
        </header>
        <article class=markdown><h1>Введение, простой echo-бот</h1>
            <p>
            <p>Приветствую тебя, читатель! Telegram Bot API – это мощный инструмент для вообще чего угодно.
                Автоматизация действий, работа с пользователями, онлайн-магазины, игры и много чего ещё. В этом учебнике
                мы научимся писать ботов для Telegram на языке Python.</p>
            <p>Сразу оговорюсь: тот бот, который получится в итоге - это лишь прототип, цель всех этих постов -
                рассказать об основах ботостроения, показать, как можно за короткое время написать простого бота для
                своих нужд.</p>
            <p>Язык программирования будет Python 3, но это не означает, что любители PHP, Ruby и т.д. в пролёте; все
                основные принципы совпадают. Я не буду особо останавливаться на описании самого языка, желающие могут
                ознакомиться с документацией по Python <a href=https://www.python.org/doc/versions/>здесь</a>.</p>
            <h2 id=подготовка-к-запуску>Подготовка к запуску</h2>
            <p>Взаимодействие ботов с людьми основано на HTTP-запросах. Чтобы не мучаться с обработкой «сырых» данных,
                воспользуемся библиотекой <a href=https://github.com/eternnoir/pyTelegramBotAPI>pyTelegramBotAPI</a>,
                которая берет на себя все нюансы отправки и получения запросов, позволяя сконцентрироваться
                непосредственно на логике. Установка библиотеки предельно простая:</p>
            <div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code
                    class=language-bash data-lang=bash>pip install pytelegrambotapi
python3
</code></pre>
            </div>
            <center><img src=https://mastergroosha.github.io/telegram-tutorial//images/l1_1.jpg></center>
            <center><i>Скриншот из терминала с запущенным интерпретатором Python</i></center>
            <blockquote class="book-hint warning">Обратите внимание: библиотека называется <code>pyTelegramBotAPI</code>,
                а не <code>telebot</code>. Последнюю ставить <strong>не нужно</strong>!
            </blockquote>
            <p>Теперь можно выйти из режима Python-консоли (Ctrl+Z или Ctrl+D, или <code>exit()</code>)</p>
            <h2 id=пишем-простого-echo-бота>Пишем простого echo-бота</h2>
            <p>Ну, довольно слов, перейдем к делу. В качестве практики к первому уроку, напишем бота, повторяющего
                присланное текстовое сообщение. Создадим каталог, а внутри него 2 файла: <code>bot.py</code> и <code>config.py</code>.
                Я рекомендую выносить различные константы и настройки в файл <code>config.py</code>, дабы не
                загромождать другие. В файл <code>config.py</code> впишем:</p>
            <div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code
                    class=language-python data-lang=python><span style=color:green># Токен ненастоящий :) Подставьте свой</span>
token = <span style=color:#a31515>&#39;1234567890:AAE_abCDEFghijKLmNOpqRsTuVWxyz&#39;</span>
</code></pre>
            </div>
            <p>Теперь надо научить бота реагировать на сообщения. Напишем обработчик, который будет реагировать на все
                текстовые сообщения.</p>
            <div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code
                    class=language-python data-lang=python>@bot.message_handler(content_types=[<span
                    style=color:#a31515>&#34;text&#34;</span>])
<span style=color:#00f>def</span> repeat_all_messages(message): <span style=color:green># Название функции не играет никакой роли</span>
    bot.send_message(message.chat.id, message.text)
</code></pre>
            </div>
            <p>У читателя возникнет вопрос: зачем там символ &ldquo;@&rdquo;? Что это вообще за
                <code>message_handler</code>? Дело в том, что после приёма сообщения от Telegram его надо обработать
                по-разному в зависимости от того, что это за сообщение: текст &ldquo;привет&rdquo; или текст &ldquo;пока&rdquo;,
                может быть, вообще стикер или музыка. Первое, что придёт в голову – написать множество конструкций
                <code>if-then-else</code>, но такой подход некрасивый и позволяет быстро запутаться.<br>Для решения этой
                проблемы автор библиотеки pyTelegramBotAPI реализовал механизм хэндлеров, которые используют питоновские
                <a href=https://devpractice.ru/python-lesson-19-decorators>декораторы</a> (пока просто запомним это
                слово). В хэндлере описывается, в каком случае необходимо выполнять ту или иную функцию. Например,
                хэндлер <code>@bot.message_handler(content_types=["text"])</code> выполнит нижестоящую функцию, если от
                Telegram придёт текстовое сообщение, а хэндлер <code>@bot.message_handler(commands=["start"])</code>
                сработает при получении команды <strong>/start</strong>.</p>
            <p>Теперь запустим бесконечный цикл получения новых записей со стороны Telegram:</p>
            <div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code
                    class=language-python data-lang=python><span style=color:#00f>if</span> __name__ == <span
                    style=color:#a31515>&#39;__main__&#39;</span>:
    bot.infinity_polling()
</code></pre>
            </div>
            <p>Функция infinity_polling запускает т.н. <a href=http://www.pubnub.com/blog/http-long-polling/>Long
                Polling</a>, бот должен стараться не прекращать работу при возникновении каких-либо ошибок. При этом,
                само собой, за ботом нужно следить, ибо сервера Telegram периодически перестают отвечать на запросы или
                делают это с большой задержкой приводя к <a
                        href=https://ru.wikipedia.org/wiki/%d0%a1%d0%bf%d0%b8%d1%81%d0%be%d0%ba_%d0%ba%d0%be%d0%b4%d0%be%d0%b2_%d1%81%d0%be%d1%81%d1%82%d0%be%d1%8f%d0%bd%d0%b8%d1%8f_HTTP#5xx>ошибкам
                    5xx</a>)</p>
            <p>Итак, полный код файла <code>bot.py</code> выглядит следующим образом:</p>
            <div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code
                    class=language-python data-lang=python><span style=color:#00f>import</span> config
<span style=color:#00f>import</span> telebot

bot = telebot.TeleBot(config.token)

@bot.message_handler(content_types=[<span style=color:#a31515>&#34;text&#34;</span>])
<span style=color:#00f>def</span> repeat_all_messages(message): <span style=color:green># Название функции не играет никакой роли</span>
    bot.send_message(message.chat.id, message.text)

<span style=color:#00f>if</span> __name__ == <span style=color:#a31515>&#39;__main__&#39;</span>:
     bot.infinity_polling()
</code></pre>
            </div>
            <p>Готово! Осталось запустить бота: <code>python3 bot.py</code></p>
            <center><img src=https://mastergroosha.github.io/telegram-tutorial//images/l1_2.jpg></center>
            <center><i>Бот работает</i></center>
            <p>На этом первый урок окончен.</p><a href=/telegram-tutorial/docs/lesson_02/ class=book-btn
                                                  style=float:right>Урок №2 →</a></p></article>
        <footer class=book-footer>
            <div class="flex flex-wrap justify-between"></div>
        </footer>
        <label class="hidden book-menu-overlay" for=menu-control></label></div>
    <aside class=book-toc>
        <nav id=TableOfContents>
            <ul>
                <li>
                    <ul>
                        <li><a href=#подготовка-к-запуску>Подготовка к запуску</a></li>
                        <li><a href=#пишем-простого-echo-бота>Пишем простого echo-бота</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </aside>
</main>
</body>
</html>